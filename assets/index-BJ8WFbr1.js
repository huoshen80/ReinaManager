import{a as H,g as E,r as c,u as F,y as D,c as P,s as I,j as s,b as O,z as K,m as $,e as z,f as w,h as U,i as V,C as X,P as Y,M as J,F as b,G as k,w as S,H as Q,I as q,D as Z,J as ee,K as te,N as T,E as se,O as oe,Q as ne,S as ae,U as ie,n as le,V as re,l as ce}from"./index-8LpMZBdz.js";import{C as ue}from"./Card-CcP84HZ5.js";import{u as me}from"./useScrollRestore-D7epZdB6.js";function de(o){return E("MuiCardActionArea",o)}const N=H("MuiCardActionArea",["root","focusVisible","focusHighlight"]),he=o=>{const{classes:n}=o;return O({root:["root"],focusHighlight:["focusHighlight"]},de,n)},ge=I(K,{name:"MuiCardActionArea",slot:"Root"})($(({theme:o})=>({display:"block",textAlign:"inherit",borderRadius:"inherit",width:"100%",[`&:hover .${N.focusHighlight}`]:{opacity:(o.vars||o).palette.action.hoverOpacity,"@media (hover: none)":{opacity:0}},[`&.${N.focusVisible} .${N.focusHighlight}`]:{opacity:(o.vars||o).palette.action.focusOpacity}}))),pe=I("span",{name:"MuiCardActionArea",slot:"FocusHighlight"})($(({theme:o})=>({overflow:"hidden",pointerEvents:"none",position:"absolute",top:0,right:0,bottom:0,left:0,borderRadius:"inherit",opacity:0,backgroundColor:"currentcolor",transition:o.transitions.create("opacity",{duration:o.transitions.duration.short})}))),fe=c.forwardRef(function(n,i){const t=F({props:n,name:"MuiCardActionArea"}),{children:m,className:v,focusVisibleClassName:d,slots:g={},slotProps:y={},...u}=t,h=t,r=he(h),p={slots:g,slotProps:y},[x,f]=D("root",{elementType:ge,externalForwardedProps:{...p,...u},shouldForwardComponentProp:!0,ownerState:h,ref:i,className:P(r.root,v),additionalProps:{focusVisibleClassName:P(d,r.focusVisible)}}),[M,e]=D("focusHighlight",{elementType:pe,externalForwardedProps:p,ownerState:h,ref:i,className:r.focusHighlight});return s.jsxs(x,{...f,children:[m,s.jsx(M,{...e})]})});function Ce(o){return E("MuiCardMedia",o)}H("MuiCardMedia",["root","media","img"]);const xe=o=>{const{classes:n,isMediaComponent:i,isImageComponent:t}=o;return O({root:["root",i&&"media",t&&"img"]},Ce,n)},ve=I("div",{name:"MuiCardMedia",slot:"Root",overridesResolver:(o,n)=>{const{ownerState:i}=o,{isMediaComponent:t,isImageComponent:m}=i;return[n.root,t&&n.media,m&&n.img]}})({display:"block",backgroundSize:"cover",backgroundRepeat:"no-repeat",backgroundPosition:"center",variants:[{props:{isMediaComponent:!0},style:{width:"100%"}},{props:{isImageComponent:!0},style:{objectFit:"cover"}}]}),ye=["video","audio","picture","iframe","img"],Me=["picture","img"],je=c.forwardRef(function(n,i){const t=F({props:n,name:"MuiCardMedia"}),{children:m,className:v,component:d="div",image:g,src:y,style:u,...h}=t,r=ye.includes(d),p=!r&&g?{backgroundImage:`url("${g}")`,...u}:u,x={...t,component:d,isMediaComponent:r,isImageComponent:Me.includes(d)},f=xe(x);return s.jsx(ve,{className:P(f.root,v),as:d,role:!r&&g?"img":void 0,ref:i,style:p,ownerState:x,src:r?g||y:void 0,...h,children:m})}),we=z(s.jsx("path",{d:"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m-5 14H7v-2h7zm3-4H7v-2h10zm0-4H7V7h10z"})),be=z(s.jsx("path",{d:"m10 16.5 6-4.5-6-4.5zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8"})),ke=({isopen:o,anchorPosition:n,setAnchorEl:i,id:t})=>{const{getGameById:m,deleteGame:v,isLocalGame:d,updateGameClearStatusInStore:g}=w(),{launchGame:y,isGameRunning:u}=U(),[h,r]=c.useState(!1),[p,x]=c.useState(!1),[f,M]=c.useState(null),{t:e}=V(),l=c.useRef(null),j=u(t===null?void 0:t);c.useEffect(()=>{o&&(async()=>{if(t!=null)try{const C=await m(t);M(C)}catch(C){console.error("获取游戏数据失败:",C)}})()},[t,o,m]);const L=()=>{if(t!=null)return T()&&d(t)&&!j};if(c.useEffect(()=>{const a=()=>{i(null)};if(o&&(document.addEventListener("click",a),document.addEventListener("scroll",a,!0),window.addEventListener("resize",a)),l.current&&n){const{offsetWidth:C,offsetHeight:B}=l.current,W=Math.min(n.top,window.innerHeight-B),_=Math.min(n.left,window.innerWidth-C);l.current.style.top=`${W}px`,l.current.style.left=`${_}px`}return()=>{document.removeEventListener("click",a),document.removeEventListener("scroll",a,!0),window.removeEventListener("resize",a)}},[o,i,n]),c.useEffect(()=>{o&&l.current&&l.current.focus()},[o]),!o||!n)return null;const G=async()=>{if(t)try{x(!0),i(null),await v(t)}catch(a){console.error("删除游戏失败:",a)}finally{i(null),x(!1),r(!1)}},R=async()=>{if(t)try{const a=await m(t);if(!a||!a.localpath){console.error(e("components.LaunchModal.gamePathNotFound"));return}await y(a.localpath,t)}catch(a){console.error(e("components.LaunchModal.launchFailed"),a)}},A=async()=>{if(t!=null)try{await ne(t,(a,C)=>{M(C)},(a,C)=>{g(a,C,!1)}),i(null)}catch(a){console.error("更新游戏通关状态失败:",a)}};return s.jsxs("div",{role:"menu","aria-label":e("components.RightMenu.label"),tabIndex:-1,className:"fixed z-50 animate-fade-in animate-duration-100 select-none",ref:l,onClick:a=>a.stopPropagation(),onKeyDown:a=>{(a.key==="Escape"||a.key==="Esc")&&i(null)},children:[s.jsx(X,{open:h,setOpen:r,onConfirm:G,isLoading:p}),s.jsx(Y,{elevation:8,sx:{minWidth:"200px",borderRadius:2,textAlign:"left"},children:s.jsxs(J,{sx:{py:1},children:[s.jsxs(b,{disabled:!L(),onClick:()=>{R(),i(null)},children:[s.jsx(k,{children:s.jsx(be,{})}),s.jsx(S,{primary:e("components.RightMenu.startGame")})]}),s.jsx(Q,{to:`/libraries/${t}`,style:{textDecoration:"none",color:"inherit"},children:s.jsxs(b,{children:[s.jsx(k,{children:s.jsx(we,{})}),s.jsx(S,{primary:e("components.RightMenu.enterDetails")})]})}),s.jsxs(b,{onClick:()=>r(!0),children:[s.jsx(k,{children:s.jsx(q,{})}),s.jsx(S,{primary:e("components.RightMenu.deleteGame")})]}),s.jsx(Z,{}),s.jsxs(b,{disabled:!(T()&&t!==void 0&&t!==null&&d(t)),onClick:()=>{te({id:t,getGameById:m}),i(null)},children:[s.jsx(k,{children:s.jsx(ee,{})}),s.jsx(S,{primary:e("components.RightMenu.openGameFolder")})]}),s.jsxs(b,{onClick:A,children:[s.jsx(k,{children:f?.clear===1?s.jsx(se,{className:"text-yellow-500"}):s.jsx(oe,{})}),s.jsx(S,{primary:f?.clear===1?e("components.RightMenu.markAsNotCompleted"):e("components.RightMenu.markAsCompleted")})]})]})})]})},Se=c.memo(({card:o,isActive:n,onContextMenu:i,onClick:t,onDoubleClick:m,onLongPress:v,displayName:d,useDelayedClick:g})=>{const{nsfwCoverReplace:y}=w(),[u,h]=c.useState(null),[r,p]=c.useState(null),[x,f]=c.useState(!1),[M,e]=c.useState(!1),l=o.tags||[],j=re(l),L=()=>{if(M){e(!1);return}if(g){u&&(clearTimeout(u),h(null));const C=setTimeout(()=>{t(),h(null)},200);h(C)}else t()},G=()=>{g&&u&&(clearTimeout(u),h(null)),m()},R=()=>{e(!1),r&&clearTimeout(r);const C=setTimeout(()=>{f(!0),e(!0),v()},800);p(C)},A=()=>{r&&(clearTimeout(r),p(null)),f(!1),setTimeout(()=>{M&&e(!1)},50)},a=()=>{r&&(clearTimeout(r),p(null)),f(!1)};return s.jsx(ue,{className:`min-w-24 max-w-full !transition-all ${n?"scale-y-105":"scale-y-100"}`,onContextMenu:i,children:s.jsxs(fe,{onClick:L,onDoubleClick:G,onMouseDown:R,onMouseUp:A,onMouseLeave:a,className:`
                    duration-100 
                    hover:shadow-lg hover:scale-105 
                    active:shadow-sm active:scale-95 
                    ${x?"ring-2 ring-blue-500 shadow-lg":""}
                `,children:[s.jsx(je,{component:"img",className:"h-auto aspect-[3/4]",image:y&&j?"/images/NR18.png":ce(o),alt:"Card Image",draggable:"false",loading:"lazy"}),s.jsx("div",{className:`p-1 h-8 text-base truncate ${n?"!font-bold text-blue-500":""}`,children:d})]})},o.id)}),Le=()=>{const o=w(e=>e.selectedGameId),n=w(e=>e.setSelectedGameId),i=w(e=>e.cardClickMode),t=w(e=>e.doubleClickLaunch),m=w(e=>e.longPressLaunch),v=w(e=>e.games),{launchGame:d}=U(),g=ae(),{i18n:y}=V(),[u,h]=c.useState(null),r=c.useCallback((e,l)=>{e!=null&&(i==="navigate"?(n(e),ie(window.location.pathname),g(`/libraries/${e}`)):n(e))},[i,g,n]),p=c.useCallback(async(e,l)=>{if(!(e==null||!l)&&t&&l.localpath){n(e);try{await d(l.localpath,e)}catch(j){console.error("启动游戏失败:",j)}}},[t,d,n]),x=c.useCallback(async(e,l)=>{if(!(e==null||!l)&&m&&l.localpath){n(e);try{await d(l.localpath,e)}catch(j){console.error("长按启动游戏失败:",j)}}},[m,d,n]),f=c.useCallback((e,l)=>{l&&(h({mouseX:e.clientX,mouseY:e.clientY,cardId:l}),n(l))},[n]),M=c.useMemo(()=>v.map(e=>{const l=le(e,y.language);return s.jsx(Se,{card:e,isActive:o===e.id,onContextMenu:j=>f(j,e.id),onClick:()=>r(e.id,e),onDoubleClick:()=>p(e.id,e),onLongPress:()=>x(e.id,e),displayName:l,useDelayedClick:i==="navigate"&&t},e.id)}),[v,o,y.language,i,t,r,p,x,f]);return s.jsxs("div",{className:"flex-1 text-center grid grid-cols-5 lg:grid-cols-6 xl:grid-cols-7 2xl:grid-cols-8 gap-4 p-4",children:[s.jsx(ke,{id:u?.cardId,isopen:!!u,anchorPosition:u?{top:u.mouseY,left:u.mouseX}:void 0,setAnchorEl:e=>{e||h(null)}}),M]})},Ne=()=>(me("/libraries",{useKeepAlive:!0}),s.jsx(Le,{}));export{Ne as Libraries};
