import{aQ as Re,aR as ie,aS as x,aT as V,aU as _,aV as X,aW as Y,aX as re,aY as Ce,aZ as z,a_ as je,a$ as Oe,b0 as ne,b1 as ge,r as d,b2 as me,b3 as J,i as Q,b4 as ee,ad as m,b5 as Ie,b6 as te,b7 as Ee,aL as Fe,f as Pe,j as a,B as A,X as N,T as C,aF as oe,aA as Te,aB as we,ay as ce,aw as F,W as U,b8 as le,D as Me,ai as H,p as Ue,q as _e,w as Qe,b9 as Le,a2 as ue,a3 as $e,a4 as he,ba as ze,bb as Ae,bc as Ne}from"./index-D1SIH30A.js";import{B as We}from"./Backup-Cknob77E.js";import{R as Ge}from"./Restore-CTvIRDOR.js";import{C as K}from"./Card-CXRbG3bK.js";import{C as q}from"./CardContent-CHLnZwAB.js";var He=class extends Re{constructor(e,s){super(),this.options=s,this.#s=e,this.#i=null,this.#a=ie(),this.bindMethods(),this.setOptions(s)}#s;#e=void 0;#f=void 0;#t=void 0;#n;#u;#a;#i;#g;#h;#d;#o;#c;#r;#p=new Set;bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){this.listeners.size===1&&(this.#e.addObserver(this),de(this.#e,this.options)?this.#l():this.updateResult(),this.#b())}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return Z(this.#e,this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return Z(this.#e,this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,this.#k(),this.#S(),this.#e.removeObserver(this)}setOptions(e){const s=this.options,t=this.#e;if(this.options=this.#s.defaultQueryOptions(e),this.options.enabled!==void 0&&typeof this.options.enabled!="boolean"&&typeof this.options.enabled!="function"&&typeof x(this.options.enabled,this.#e)!="boolean")throw new Error("Expected enabled to be a boolean or a callback that returns a boolean");this.#B(),this.#e.setOptions(this.options),s._defaulted&&!V(this.options,s)&&this.#s.getQueryCache().notify({type:"observerOptionsUpdated",query:this.#e,observer:this});const i=this.hasListeners();i&&pe(this.#e,t,this.options,s)&&this.#l(),this.updateResult(),i&&(this.#e!==t||x(this.options.enabled,this.#e)!==x(s.enabled,this.#e)||_(this.options.staleTime,this.#e)!==_(s.staleTime,this.#e))&&this.#m();const r=this.#v();i&&(this.#e!==t||x(this.options.enabled,this.#e)!==x(s.enabled,this.#e)||r!==this.#r)&&this.#x(r)}getOptimisticResult(e){const s=this.#s.getQueryCache().build(this.#s,e),t=this.createResult(s,e);return qe(this,t)&&(this.#t=t,this.#u=this.options,this.#n=this.#e.state),t}getCurrentResult(){return this.#t}trackResult(e,s){return new Proxy(e,{get:(t,i)=>(this.trackProp(i),s?.(i),i==="promise"&&(this.trackProp("data"),!this.options.experimental_prefetchInRender&&this.#a.status==="pending"&&this.#a.reject(new Error("experimental_prefetchInRender feature flag is not enabled"))),Reflect.get(t,i))})}trackProp(e){this.#p.add(e)}getCurrentQuery(){return this.#e}refetch({...e}={}){return this.fetch({...e})}fetchOptimistic(e){const s=this.#s.defaultQueryOptions(e),t=this.#s.getQueryCache().build(this.#s,s);return t.fetch().then(()=>this.createResult(t,s))}fetch(e){return this.#l({...e,cancelRefetch:e.cancelRefetch??!0}).then(()=>(this.updateResult(),this.#t))}#l(e){this.#B();let s=this.#e.fetch(this.options,e);return e?.throwOnError||(s=s.catch(X)),s}#m(){this.#k();const e=_(this.options.staleTime,this.#e);if(Y||this.#t.isStale||!re(e))return;const t=Ce(this.#t.dataUpdatedAt,e)+1;this.#o=z.setTimeout(()=>{this.#t.isStale||this.updateResult()},t)}#v(){return(typeof this.options.refetchInterval=="function"?this.options.refetchInterval(this.#e):this.options.refetchInterval)??!1}#x(e){this.#S(),this.#r=e,!(Y||x(this.options.enabled,this.#e)===!1||!re(this.#r)||this.#r===0)&&(this.#c=z.setInterval(()=>{(this.options.refetchIntervalInBackground||je.isFocused())&&this.#l()},this.#r))}#b(){this.#m(),this.#x(this.#v())}#k(){this.#o&&(z.clearTimeout(this.#o),this.#o=void 0)}#S(){this.#c&&(z.clearInterval(this.#c),this.#c=void 0)}createResult(e,s){const t=this.#e,i=this.options,r=this.#t,h=this.#n,o=this.#u,S=e!==t?e.state:this.#f,{state:p}=e;let c={...p},b=!1,u;if(s._optimisticResults){const g=this.hasListeners(),R=!g&&de(e,s),O=g&&pe(e,t,s,i);(R||O)&&(c={...c,...Oe(p.data,e.options)}),s._optimisticResults==="isRestoring"&&(c.fetchStatus="idle")}let{error:j,errorUpdatedAt:L,status:f}=c;u=c.data;let P=!1;if(s.placeholderData!==void 0&&u===void 0&&f==="pending"){let g;r?.isPlaceholderData&&s.placeholderData===o?.placeholderData?(g=r.data,P=!0):g=typeof s.placeholderData=="function"?s.placeholderData(this.#d?.state.data,this.#d):s.placeholderData,g!==void 0&&(f="success",u=ne(r?.data,g,s),b=!0)}if(s.select&&u!==void 0&&!P)if(r&&u===h?.data&&s.select===this.#g)u=this.#h;else try{this.#g=s.select,u=s.select(u),u=ne(r?.data,u,s),this.#h=u,this.#i=null}catch(g){this.#i=g}this.#i&&(j=this.#i,u=this.#h,L=Date.now(),f="error");const T=c.fetchStatus==="fetching",y=f==="pending",B=f==="error",w=y&&T,D=u!==void 0,v={status:f,fetchStatus:c.fetchStatus,isPending:y,isSuccess:f==="success",isError:B,isInitialLoading:w,isLoading:w,data:u,dataUpdatedAt:c.dataUpdatedAt,error:j,errorUpdatedAt:L,failureCount:c.fetchFailureCount,failureReason:c.fetchFailureReason,errorUpdateCount:c.errorUpdateCount,isFetched:c.dataUpdateCount>0||c.errorUpdateCount>0,isFetchedAfterMount:c.dataUpdateCount>S.dataUpdateCount||c.errorUpdateCount>S.errorUpdateCount,isFetching:T,isRefetching:T&&!y,isLoadingError:B&&!D,isPaused:c.fetchStatus==="paused",isPlaceholderData:b,isRefetchError:B&&D,isStale:se(e,s),refetch:this.refetch,promise:this.#a,isEnabled:x(s.enabled,e)!==!1};if(this.options.experimental_prefetchInRender){const g=v.data!==void 0,R=v.status==="error"&&!g,O=E=>{R?E.reject(v.error):g&&E.resolve(v.data)},$=()=>{const E=this.#a=v.promise=ie();O(E)},I=this.#a;switch(I.status){case"pending":e.queryHash===t.queryHash&&O(I);break;case"fulfilled":(R||v.data!==I.value)&&$();break;case"rejected":(!R||v.error!==I.reason)&&$();break}}return v}updateResult(){const e=this.#t,s=this.createResult(this.#e,this.options);if(this.#n=this.#e.state,this.#u=this.options,this.#n.data!==void 0&&(this.#d=this.#e),V(s,e))return;this.#t=s;const t=()=>{if(!e)return!0;const{notifyOnChangeProps:i}=this.options,r=typeof i=="function"?i():i;if(r==="all"||!r&&!this.#p.size)return!0;const h=new Set(r??this.#p);return this.options.throwOnError&&h.add("error"),Object.keys(this.#t).some(o=>{const l=o;return this.#t[l]!==e[l]&&h.has(l)})};this.#y({listeners:t()})}#B(){const e=this.#s.getQueryCache().build(this.#s,this.options);if(e===this.#e)return;const s=this.#e;this.#e=e,this.#f=e.state,this.hasListeners()&&(s?.removeObserver(this),e.addObserver(this))}onQueryUpdate(){this.updateResult(),this.hasListeners()&&this.#b()}#y(e){ge.batch(()=>{e.listeners&&this.listeners.forEach(s=>{s(this.#t)}),this.#s.getQueryCache().notify({query:this.#e,type:"observerResultsUpdated"})})}};function Ke(e,s){return x(s.enabled,e)!==!1&&e.state.data===void 0&&!(e.state.status==="error"&&s.retryOnMount===!1)}function de(e,s){return Ke(e,s)||e.state.data!==void 0&&Z(e,s,s.refetchOnMount)}function Z(e,s,t){if(x(s.enabled,e)!==!1&&_(s.staleTime,e)!=="static"){const i=typeof t=="function"?t(e):t;return i==="always"||i!==!1&&se(e,s)}return!1}function pe(e,s,t,i){return(e!==s||x(i.enabled,e)===!1)&&(!t.suspense||e.state.status!=="error")&&se(e,t)}function se(e,s){return x(s.enabled,e)!==!1&&e.isStaleByTime(_(s.staleTime,e))}function qe(e,s){return!V(e.getCurrentResult(),s)}var ve=d.createContext(!1),Ve=()=>d.useContext(ve);ve.Provider;function Xe(){let e=!1;return{clearReset:()=>{e=!1},reset:()=>{e=!0},isReset:()=>e}}var Ye=d.createContext(Xe()),Ze=()=>d.useContext(Ye),Je=(e,s,t)=>{const i=t?.state.error&&typeof e.throwOnError=="function"?me(e.throwOnError,[t.state.error,t]):e.throwOnError;(e.suspense||e.experimental_prefetchInRender||i)&&(s.isReset()||(e.retryOnMount=!1))},et=e=>{d.useEffect(()=>{e.clearReset()},[e])},tt=({result:e,errorResetBoundary:s,throwOnError:t,query:i,suspense:r})=>e.isError&&!s.isReset()&&!e.isFetching&&i&&(r&&e.data===void 0||me(t,[e.error,i])),st=e=>{if(e.suspense){const t=r=>r==="static"?r:Math.max(r??1e3,1e3),i=e.staleTime;e.staleTime=typeof i=="function"?(...r)=>t(i(...r)):t(i),typeof e.gcTime=="number"&&(e.gcTime=Math.max(e.gcTime,1e3))}},at=(e,s)=>e.isLoading&&e.isFetching&&!s,it=(e,s)=>e?.suspense&&s.isPending,fe=(e,s,t)=>s.fetchOptimistic(e).catch(()=>{t.clearReset()});function rt(e,s,t){const i=Ve(),r=Ze(),h=J(),o=h.defaultQueryOptions(e);h.getDefaultOptions().queries?._experimental_beforeQuery?.(o);const l=h.getQueryCache().get(o.queryHash);o._optimisticResults=i?"isRestoring":"optimistic",st(o),Je(o,r,l),et(r);const S=!h.getQueryCache().get(o.queryHash),[p]=d.useState(()=>new s(h,o)),c=p.getOptimisticResult(o),b=!i&&e.subscribed!==!1;if(d.useSyncExternalStore(d.useCallback(u=>{const j=b?p.subscribe(ge.batchCalls(u)):X;return p.updateResult(),j},[p,b]),()=>p.getCurrentResult(),()=>p.getCurrentResult()),d.useEffect(()=>{p.setOptions(o)},[o,p]),it(o,c))throw fe(o,p,r);if(tt({result:c,errorResetBoundary:r,throwOnError:o.throwOnError,query:l,suspense:o.suspense}))throw c.error;return h.getDefaultOptions().queries?._experimental_afterQuery?.(o,c),o.experimental_prefetchInRender&&!Y&&at(c,i)&&(S?fe(o,p,r):l?.promise)?.catch(X).finally(()=>{p.updateResult()}),o.notifyOnChangeProps?c:p.trackResult(c)}function nt(e,s){return rt(e,He)}const ae={all:["saveData"],backups:e=>["saveData","backups",e]};function ot(e){const{t:s}=Q();return nt({queryKey:ae.backups(e??0),queryFn:async()=>e?te.getSavedataRecords(e):[],enabled:!!e,staleTime:1/0,refetchOnWindowFocus:!1,retry:1,meta:{errorMessage:s("pages.Detail.Backup.loadBackupsFailed","加载备份列表失败")}})}function ct(){const e=J(),{t:s}=Q();return ee({mutationFn:async({gameId:t,savePath:i})=>Ie(t,i),onSuccess:(t,i)=>{m.success(s("pages.Detail.Backup.backupSuccess","备份创建成功")),e.invalidateQueries({queryKey:ae.backups(i.gameId)})},onError:t=>{m.error(`${s("pages.Detail.Backup.backupFailed","备份失败")}: ${t.message}`)}})}function lt(){const e=J(),{t:s}=Q();return ee({mutationFn:async({backup:t})=>{await te.deleteBackup(t.id)},onSuccess:()=>{m.success(s("pages.Detail.Backup.deleteSuccess","备份删除成功"))},onError:t=>{m.error(`${s("pages.Detail.Backup.deleteFailed","删除失败")}: ${t}`)},onSettled:(t,i,r)=>{e.invalidateQueries({queryKey:ae.backups(r.gameId)})}})}function ut(){const{t:e}=Q();return ee({mutationFn:async({gameId:s,backup:t,savePath:i})=>{const r=await Ee(s),h=Fe(r,t.file);await te.restoreBackup(h,i)},onSuccess:()=>{m.success(e("pages.Detail.Backup.restoreSuccess","存档恢复成功"))},onError:s=>{m.error(`${e("pages.Detail.Backup.restoreFailed","恢复失败")}: ${s.message}`)}})}const mt=()=>{const{selectedGame:e,updateGame:s}=Pe(),{t}=Q(),{data:i=[]}=ot(e?.id),r=ct(),h=lt(),o=ut(),[l,S]=d.useState(""),[p,c]=d.useState(!1),[b,u]=d.useState(null),[j,L]=d.useState(!1),[f,P]=d.useState(!1),[T,y]=d.useState(!1),[B,w]=d.useState(null),[D,W]=d.useState(20);d.useEffect(()=>{e&&(L(e.autosave===1),S(e.savepath||""),W(e.maxbackups??20))},[e]);const v=async(n,k,G)=>{if(e?.id){P(!0);try{await s(e.id,n),m.success(k)}catch(M){throw m.error(`${G}: ${M}`),M}finally{P(!1)}}},g=async()=>{const n=await ze();n&&S(n)},R=async()=>{await v({savepath:l},t("pages.Detail.Backup.pathUpdateSuccess","存档路径更新成功"),t("pages.Detail.Backup.pathUpdateFailed","路径更新失败"))},O=async n=>{const k=n?t("pages.Detail.Backup.autoSaveEnabled","自动备份已启用"):t("pages.Detail.Backup.autoSaveDisabled","自动备份已禁用");await v({autosave:n?1:0},k,t("pages.Detail.Backup.autoSaveUpdateFailed","自动备份设置失败"))},$=async()=>{if(!e?.id||D<1){m.error(t("pages.Detail.Backup.invalidMaxBackups","最大备份数量必须大于0"));return}await v({maxbackups:D},t("pages.Detail.Backup.maxBackupsUpdateSuccess","最大备份数量更新成功"),t("pages.Detail.Backup.maxBackupsUpdateFailed","最大备份数量更新失败"))},I=async()=>{if(!l||!e?.id){m.error(t("pages.Detail.Backup.pathRequired","请先选择存档文件夹"));return}await r.mutateAsync({gameId:e.id,savePath:l})},E=async()=>{if(e?.id)try{await Ae(e.id)}catch(n){m.error(`${t("pages.Detail.Backup.openBackupFolderFailed","打开备份文件夹失败")}: ${n}`)}},xe=async()=>{if(!l){m.error(t("pages.Detail.Backup.pathRequired","请先选择存档文件夹"));return}try{await Ne(l)}catch(n){m.error(`${t("pages.Detail.Backup.openSaveDataFolderFailed","打开存档文件夹失败")}: ${n}`)}},be=n=>{u(n),c(!0)},ke=async()=>{!b||!e?.id||h.mutate({gameId:e.id,backup:b},{onSettled:()=>{c(!1),u(null)}})},Se=n=>{if(!l){m.error(t("pages.Detail.Backup.pathRequired","请先选择存档文件夹"));return}w(n),y(!0)},Be=async()=>{!B||!l||!e?.id||(await o.mutateAsync({gameId:e.id,backup:B,savePath:l}),y(!1),w(null))},ye=n=>{if(n===0)return"0 B";const k=1024,G=["B","KB","MB","GB"],M=Math.floor(Math.log(n)/Math.log(k));return`${Number.parseFloat((n/k**M).toFixed(2))} ${G[M]}`},De=n=>new Date(n*1e3).toLocaleString();return a.jsxs(A,{sx:{p:3},children:[a.jsxs(N,{spacing:3,children:[a.jsx(K,{children:a.jsxs(q,{children:[a.jsx(C,{variant:"h6",gutterBottom:!0,children:t("pages.Detail.Backup.settings","备份设置")}),a.jsxs(N,{spacing:2,children:[a.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:2},children:[a.jsx(oe,{title:e?.savepath?"":t("pages.Detail.Backup.setPathForAutosave","请先设置存档路径以启用自动备份"),children:a.jsx("div",{children:a.jsx(Te,{control:a.jsx(we,{checked:j,onChange:n=>O(n.target.checked),disabled:f||!e?.savepath}),label:t("pages.Detail.Backup.autoSave","自动备份")})})}),a.jsxs(A,{sx:{display:"flex",alignItems:"center",gap:1},children:[a.jsx(ce,{label:t("pages.Detail.Backup.maxBackups","最大备份数量"),type:"number",variant:"outlined",size:"small",value:D,onChange:n=>{const k=Number.parseInt(n.target.value,10);!Number.isNaN(k)&&k>0&&W(k)},disabled:f||!e}),a.jsx(F,{variant:"outlined",onClick:$,disabled:f||!e||D<1,startIcon:f?a.jsx(U,{size:16}):a.jsx(le,{}),children:t("pages.Detail.Backup.save","保存")})]})]}),a.jsx(Me,{}),a.jsx(C,{variant:"subtitle2",color:"textSecondary",children:t("pages.Detail.Backup.savePathSettings","存档路径设置")}),a.jsxs(A,{sx:{display:"flex",gap:1},children:[a.jsx(ce,{label:t("pages.Detail.Backup.saveDataPath","存档文件夹路径"),variant:"outlined",fullWidth:!0,value:l,onChange:n=>S(n.target.value),disabled:r.isPending||f||!e,placeholder:t("pages.Detail.Backup.selectSaveDataFolder","选择存档文件夹")}),a.jsx(F,{variant:"outlined",onClick:g,disabled:r.isPending||f||!e,sx:{minWidth:"40px",px:1},children:a.jsx(H,{})}),a.jsx(F,{variant:"outlined",onClick:R,disabled:r.isPending||f||!e||!l,startIcon:f?a.jsx(U,{size:16}):a.jsx(le,{}),sx:{minWidth:"100px"},children:f?t("pages.Detail.Backup.updating","更新中..."):t("pages.Detail.Backup.updatePath","更新路径")})]})]})]})}),a.jsx(K,{children:a.jsxs(q,{children:[a.jsx(C,{variant:"h6",gutterBottom:!0,children:t("pages.Detail.Backup.manualBackup","手动备份")}),a.jsxs(N,{spacing:2,children:[a.jsx(F,{variant:"contained",color:"primary",size:"large",fullWidth:!0,onClick:I,disabled:r.isPending||!l||!e?.savepath,startIcon:r.isPending?a.jsx(U,{size:20,color:"inherit"}):a.jsx(We,{}),children:r.isPending?t("pages.Detail.Backup.creating","正在创建备份..."):t("pages.Detail.Backup.createBackup","创建备份")}),a.jsxs(N,{direction:"row",spacing:1,children:[a.jsx(F,{variant:"outlined",size:"medium",onClick:()=>E(),disabled:!e,startIcon:a.jsx(H,{}),sx:{flex:1},children:t("pages.Detail.Backup.openBackupFolder","打开备份文件夹")}),a.jsx(F,{variant:"outlined",size:"medium",onClick:()=>xe(),disabled:!l||!e?.savepath,startIcon:a.jsx(H,{}),sx:{flex:1},children:t("pages.Detail.Backup.openSaveDataFolder","打开存档文件夹")})]})]})]})}),a.jsx(K,{children:a.jsxs(q,{children:[a.jsx(C,{variant:"h6",gutterBottom:!0,children:t("pages.Detail.Backup.backupHistory","备份历史")}),i.length===0?a.jsx(C,{color:"textSecondary",component:"div",children:t("pages.Detail.Backup.noBackups","暂无备份记录")}):a.jsx(Ue,{children:i.map(n=>a.jsxs(_e,{divider:!0,children:[a.jsx(Qe,{primary:n.file,secondary:a.jsxs(a.Fragment,{children:[a.jsxs(C,{variant:"body2",color:"textSecondary",component:"span",children:[t("pages.Detail.Backup.backupTime","备份时间"),":"," ",De(n.backup_time)]}),a.jsx("br",{}),a.jsxs(C,{variant:"body2",color:"textSecondary",component:"span",children:[t("pages.Detail.Backup.fileSize","文件大小"),":"," ",ye(n.file_size)]})]})}),a.jsxs(Le,{children:[a.jsx(oe,{title:l?t("pages.Detail.Backup.restoreBackup","恢复备份"):t("pages.Detail.Backup.setPathForRestore","请先设置存档路径以恢复备份"),children:a.jsx("span",{children:a.jsx(ue,{edge:"end",onClick:()=>Se(n),disabled:r.isPending||o.isPending||!l||!e?.savepath,color:"primary",sx:{mr:1},children:o.isPending&&o.variables?.backup.id===n.id?a.jsx(U,{size:24}):a.jsx(Ge,{})})})}),a.jsx(ue,{edge:"end",onClick:()=>be(n),disabled:r.isPending||o.isPending||h.isPending,color:"error",children:h.isPending?a.jsx(U,{size:24,color:"error"}):a.jsx($e,{})})]})]},n.id))})]})})]}),a.jsx(he,{open:p,setOpen:c,onConfirm:ke,isLoading:h.isPending,title:t("components.AlertBox.deleteBackupTitle","删除备份"),message:b?`${t("pages.Detail.Backup.confirmDelete","确定要删除备份")} "${b.file}" ${t("pages.Detail.Backup.confirmDeleteSuffix","吗？此操作不可撤销。")}`:void 0}),a.jsx(he,{open:T,setOpen:y,onConfirm:Be,isLoading:o.isPending,title:t("pages.Detail.Backup.restoreBackupTitle","恢复存档"),message:B?`${t("pages.Detail.Backup.confirmRestore","确定要恢复备份")} "${B.file}"${t("pages.Detail.Backup.confirmRestoreSuffix"," 吗？这将覆盖当前存档，建议在恢复前先创建新备份。")}`:void 0,confirmText:t("pages.Detail.Backup.confirmRestoreButton","恢复"),confirmColor:"warning"})]})};export{mt as Backup};
