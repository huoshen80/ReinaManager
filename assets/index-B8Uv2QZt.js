import{e as V,j as t,i as Z,Z as Ce,$ as F,a0 as _,a1 as he,w as H,r as u,B as x,T as D,a2 as fe,a3 as xe,a4 as ye,f as w,a5 as je,a6 as M,a7 as X,a8 as E,a9 as U,aa as Ge,ab as be,ac as W,ad as I}from"./index-D1SIH30A.js";import{B as Me,a as De,C as Se}from"./index-2HUKuwhY.js";import{C as ve}from"./Card-CXRbG3bK.js";import{C as Ie}from"./CardContent-CHLnZwAB.js";import{u as Ne}from"./useScrollRestore-OqMkFYbK.js";const ke=V(t.jsx("path",{d:"M18.41 5.8 17.2 4.59c-.78-.78-2.05-.78-2.83 0l-2.68 2.68L3 15.96V20h4.04l8.74-8.74 2.63-2.63c.79-.78.79-2.05 0-2.83M6.21 18H5v-1.21l8.66-8.66 1.21 1.21zM11 20l4-4h6v4z"})),L=V(t.jsx("path",{d:"M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8z"})),$=V(t.jsx("path",{d:"M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"})),Re=({isopen:n,anchorPosition:r,setAnchorEl:g,type:d,id:h,onOpenRename:C,onOpenManageGames:y})=>{const{t:i}=Z();return h?t.jsx(Me,{isopen:n,anchorPosition:r,onClose:()=>g(null),ariaLabel:i(d==="group"?"components.RightMenu.Collection.groupMenu":"components.RightMenu.Collection.categoryMenu"),children:t.jsxs(Ce,{sx:{py:1},children:[d==="category"&&t.jsxs(F,{onClick:y,children:[t.jsx(_,{children:t.jsx(he,{})}),t.jsx(H,{primary:i("components.RightMenu.Collection.manageGames")})]}),t.jsxs(F,{onClick:C,children:[t.jsx(_,{children:t.jsx(ke,{})}),t.jsx(H,{primary:i(d==="group"?"components.RightMenu.Collection.renameGroup":"components.RightMenu.Collection.renameCategory")})]})]})}):null},O=u.memo(({entity:n,onClick:r,onDelete:g,onContextMenu:d,showDelete:h=!0,deleteTitle:C,deleteMessage:y,countLabel:i})=>{const[l,f]=u.useState(!1),[N,m]=u.useState(!1),k=G=>{G.stopPropagation(),f(!0)},R=async()=>{if(g){m(!0);try{await g(n.id)}finally{m(!1),f(!1)}}},j=G=>{G.preventDefault(),d(G,n.id,n.name)};return t.jsxs(x,{sx:{p:1,position:"relative"},children:[t.jsxs(ve,{onContextMenu:j,children:[t.jsx(De,{onClick:r,children:t.jsxs(Ie,{children:[t.jsxs(x,{display:"flex",alignItems:"center",gap:1,mb:1,children:[t.jsx(L,{color:"primary"}),t.jsx(D,{variant:"h6",component:"div",children:n.name})]}),t.jsxs(D,{variant:"body2",color:"text.secondary",children:[n.count," ",i]})]})}),h&&g&&t.jsx(fe,{sx:{position:"absolute",top:8,right:8,bgcolor:"background.paper","&:hover":{bgcolor:"error.light",color:"error.contrastText"}},size:"small",onClick:k,disabled:N,children:t.jsx(xe,{fontSize:"small"})})]}),t.jsx(ye,{open:l,setOpen:f,onConfirm:R,isLoading:N,title:C,message:y})]})});O.displayName="EntityCard";const ze=()=>{const{t:n}=Z();Ne("/collection");const{currentGroupId:r,currentCategories:g,fetchCategoriesByGroup:d,fetchGamesByCategory:h,setSelectedCategory:C,setCurrentGroup:y,allGames:i,selectedCategoryId:l,selectedCategoryName:f,categoryGames:N,groups:m,deleteCategory:k,deleteGroup:R}=w(),j=je(i),[G,q]=u.useState(new Map),[b,S]=u.useState(null),[J,z]=u.useState(!1),[K,B]=u.useState(!1),[s,A]=u.useState(null);u.useEffect(()=>{!r&&!l&&(async()=>{const o=new Map;if(o.set(M.DEVELOPER,i.length),o.set(M.PLAY_STATUS,i.length),m.length>0)try{const a=m.map(c=>c.id),p=await W.batchCountGamesInGroups(a);for(const[c,ge]of Object.entries(p))o.set(c,ge)}catch(a){console.error("Failed to batch get game counts for groups:",a);for(const p of m)try{const c=await W.countGamesInGroup(p.id);o.set(p.id.toString(),c)}catch(c){console.error(`Failed to get game count for group ${p.id}:`,c),o.set(p.id.toString(),0)}}q(o)})()},[r,l,m,i.length]),u.useEffect(()=>{r&&d(r)},[r,d]),u.useEffect(()=>{l!==null&&h(l,f||void 0)},[l,f,h]);const Q=e=>{y(e)},ee=e=>{r&&(j.isVirtual(e.id)?C(e.id,e.name):C(e.id))},te=async e=>{try{await k(e),r&&await d(r),I.success(n("pages.Collection.success.categoryDeleted",{defaultValue:"已删除分类"}))}catch(o){console.error("删除分类失败:",o),I.error(n("pages.Collection.errors.deleteCategoryFailed",{defaultValue:"删除分类失败，请重试"}))}},oe=async e=>{try{if(e.startsWith("default_")){I.warning(n("pages.Collection.errors.cannotDeleteDefaultGroup",{defaultValue:"默认分组不能删除"}));return}await R(Number.parseInt(e,10)),I.success(n("pages.Collection.success.groupDeleted",{defaultValue:"已删除分组"}))}catch(o){console.error("删除分组失败:",o),I.error(n("pages.Collection.errors.deleteGroupFailed",{defaultValue:"删除分组失败，请重试"}))}},ne=(e,o,a)=>{S({mouseX:e.clientX,mouseY:e.clientY,type:"group",id:o,name:a}),A({type:"group",id:o,name:a})},re=(e,o,a)=>{S({mouseX:e.clientX,mouseY:e.clientY,type:"category",id:o,name:a}),A({type:"category",id:o,name:a})},ae=()=>{S(null),z(!0)},se=async()=>{if(!s||s.type!=="category")return;S(null);const e=s.id;await h(e),B(!0)},le=async e=>{if(!(!s||!e.trim()))try{if(s.type==="group"){const o=Number.parseInt(s.id,10);if(Number.isNaN(o))return;await w.getState().renameGroup(o,e)}else{const o=s.id;await w.getState().renameCategory(o,e)}}catch(o){console.error("重命名失败:",o)}},T=e=>{e==="root"?(y(null),C(null)):e==="group"&&C(null)},ie=()=>{if(!r)return"";switch(r){case M.DEVELOPER:return n("pages.Collection.defaultGroups.developer");case M.PLAY_STATUS:return n("pages.Collection.defaultGroups.playStatus");default:return m.find(o=>o.id.toString()===r)?.name||""}},ce=()=>{if(l===null)return"";const e=j.getVirtualCategoryName(l,f);return e||g.find(a=>a.id===l)?.name||n("pages.Collection.breadcrumb.unknownCategory")},P=r?j.getCategoriesByGroupId(r,g):[],Y=ie(),ue=ce(),v=r&&l!==null?"games":r?"categories":"groups",pe=[{id:M.DEVELOPER,name:n("pages.Collection.defaultGroups.developer")},{id:M.PLAY_STATUS,name:n("pages.Collection.defaultGroups.playStatus")}],de=m.map(e=>({id:e.id.toString(),name:e.name})),me=[...pe,...de];return t.jsxs(x,{sx:{p:3,pt:0},children:[t.jsx(x,{className:"sticky top-0 z-10 pt-4 mb-2",sx:{backgroundColor:"background.paper",borderColor:"divider"},children:v==="groups"?t.jsx(D,{variant:"h4",children:n("pages.Collection.breadcrumb.group")}):v==="categories"?t.jsxs(X,{separator:t.jsx($,{fontSize:"small"}),"aria-label":"breadcrumb",children:[t.jsxs(E,{underline:"hover",className:"flex items-center cursor-pointer",sx:{color:"inherit","&:hover":{color:"primary.dark"}},onClick:()=>T("root"),children:[t.jsx(U,{className:"mr-1",sx:{fontSize:"inherit"}}),n("pages.Collection.breadcrumb.group")]}),t.jsxs(D,{className:"flex items-center font-600",sx:{color:"text.primary"},children:[t.jsx(L,{className:"mr-1",sx:{fontSize:"inherit"}}),Y]})]}):t.jsxs(X,{separator:t.jsx($,{fontSize:"small"}),"aria-label":"breadcrumb",children:[t.jsxs(E,{underline:"hover",className:"flex items-center cursor-pointer",sx:{color:"inherit","&:hover":{color:"primary.dark"}},onClick:()=>T("root"),children:[t.jsx(U,{className:"mr-1",sx:{fontSize:"inherit"}}),n("pages.Collection.breadcrumb.group")]}),t.jsxs(E,{underline:"hover",className:"flex items-center cursor-pointer",sx:{color:"inherit","&:hover":{color:"primary.dark"}},onClick:()=>T("group"),children:[t.jsx(L,{className:"mr-1",sx:{fontSize:"inherit"}}),Y]}),t.jsx(D,{className:"flex items-center font-600",sx:{color:"text.primary"},children:ue})]})}),v==="groups"&&t.jsx(x,{sx:{display:"grid",gridTemplateColumns:{xs:"repeat(1, 1fr)",sm:"repeat(2, 1fr)",md:"repeat(3, 1fr)",lg:"repeat(4, 1fr)"},gap:2},children:me.map(e=>{const o=e.id.startsWith("default_");return t.jsx(O,{entity:{id:e.id,name:e.name,count:G.get(e.id)||0},onClick:()=>Q(e.id),onDelete:o?void 0:a=>oe(a),onContextMenu:(a,p,c)=>{o||ne(a,p,c)},showDelete:!o,deleteTitle:n("pages.Collection.deleteGroupTitle"),deleteMessage:n("pages.Collection.deleteGroupMessage",{name:e.name}),countLabel:n("pages.Collection.gamesCount")},e.id)})}),v==="categories"&&(P.length===0?t.jsx(x,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px"},children:t.jsx(D,{variant:"h6",color:"text.secondary",children:n("pages.Collection.noCategoriesHint")})}):t.jsx(x,{sx:{display:"grid",gridTemplateColumns:{xs:"repeat(1, 1fr)",sm:"repeat(2, 1fr)",md:"repeat(3, 1fr)",lg:"repeat(4, 1fr)"},gap:2},children:P.map(e=>{const o=j.isVirtual(e.id);return t.jsx(O,{entity:{id:e.id,name:e.name,count:e.game_count},onClick:()=>ee(e),onDelete:o?void 0:a=>te(a),onContextMenu:(a,p,c)=>{o||re(a,p,c)},showDelete:!o,deleteTitle:n("pages.Collection.deleteCategoryTitle"),deleteMessage:n("pages.Collection.deleteCategoryMessage",{name:e.name}),countLabel:n("pages.Collection.gamesCount")},e.id)})})),v==="games"&&t.jsx(Se,{gamesData:N,categoryId:l!==null&&l>0?l:void 0}),t.jsx(Re,{isopen:!!b,anchorPosition:b?{top:b.mouseY,left:b.mouseX}:void 0,setAnchorEl:()=>S(null),type:b?.type||"group",id:b?.id||null,onOpenRename:ae,onOpenManageGames:se}),s&&t.jsx(Ge,{open:J,onClose:()=>z(!1),onConfirm:le,title:s.type==="group"?n("components.RightMenu.Collection.renameGroupTitle"):n("components.RightMenu.Collection.renameCategoryTitle"),label:s.type==="group"?n("components.RightMenu.Collection.newGroupName"):n("components.RightMenu.Collection.newCategoryName"),placeholder:s.name}),s&&s.type==="category"&&typeof s.id=="number"&&t.jsx(be,{open:K,onClose:()=>B(!1),categoryId:s.id,categoryName:s.name})]})};export{ze as Collection};
