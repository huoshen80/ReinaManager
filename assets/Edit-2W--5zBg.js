import{e as H,j as t,i as O,r as m,aM as J,aN as K,aO as Q,B as I,aP as X,ag as Y,am as Z,F as C,ah as L,al as N,a7 as T,au as G,aw as v,aQ as ee,aR as V,ad as k,n as U,a5 as B,T as j,a8 as S,aj as te,I as ae,J as re,l as W,aS as oe,f as se,a3 as ne,aT as ie,aU as F}from"./index-8LpMZBdz.js";import{S as le}from"./Save-4_kBfRSx.js";import{r as ce}from"./index-OSLxvytU.js";import{C as P}from"./Card-CcP84HZ5.js";import{C as R}from"./CardContent-BVd1vCqa.js";const ue=H([t.jsx("circle",{cx:"12",cy:"12",r:"3.2"},"0"),t.jsx("path",{d:"M9 2 7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5"},"1")]),de=({bgmToken:e,selectedGame:o,onDataFetched:n,disabled:a=!1})=>{const{t:s}=O(),[i,h]=m.useState(o?.bgm_id||""),[d,g]=m.useState(o?.vndb_id||""),[l,f]=m.useState(o?.id_type||""),[x,c]=m.useState(!1);m.useEffect(()=>{h(o?.bgm_id||""),g(o?.vndb_id||""),f(o?.id_type||"")},[o]);const D=m.useCallback(async()=>{if(!o)throw new Error(s("pages.Detail.DataSourceUpdate.noGameSelected","未选择游戏"));if(l==="custom")throw new Error(s("pages.Detail.DataSourceUpdate.customModeWarning","自定义模式无法从数据源更新。"));let u;if(l==="bgm"){if(!i)throw new Error(s("pages.Detail.DataSourceUpdate.bgmIdRequired","Bangumi ID 不能为空"));const p=await J(i,e);if(typeof p=="string")throw new Error(p);u=p}else if(l==="vndb"){if(!d)throw new Error(s("pages.Detail.DataSourceUpdate.vndbIdRequired","VNDB ID 不能为空"));const p=await K(d);if(typeof p=="string")throw new Error(p);u=p}else{if(!i&&!d)throw new Error(s("pages.Detail.DataSourceUpdate.bgmOrVndbIdRequired","Bangumi ID 或 VNDB ID 不能为空"));const{bgm_data:p,vndb_data:b}=await Q({bgm_id:i||void 0,vndb_id:d||void 0,BGM_TOKEN:e});let w;if(!p&&!b)throw new Error(s("pages.Detail.DataSourceUpdate.noDataFetched","未获取到数据或数据源无效。"));p&&!b?w="bgm":!p&&b?w="vndb":w="mixed",u={game:{...p?.game,...b?.game,id_type:w},bgm_data:p?.bgm_data||null,vndb_data:b?.vndb_data||null,other_data:null}}return u},[l,i,d,e,o,s]),y=async()=>{c(!0);try{const u=await D();n(u)}catch(u){const p=u instanceof Error?u.message:s("pages.Detail.DataSourceUpdate.unknownError","未知错误");v.error(p)}finally{c(!1)}},_=u=>{f(u.target.value)};return t.jsxs(I,{sx:{display:"flex",flexDirection:"column",gap:3},children:[t.jsxs(X,{fullWidth:!0,disabled:x||a||!o,children:[t.jsx(Y,{id:"id-type-label",children:s("pages.Detail.DataSourceUpdate.dataSource","数据源")}),t.jsxs(Z,{labelId:"id-type-label",value:l,onChange:_,label:s("pages.Detail.DataSourceUpdate.dataSource","数据源"),children:[t.jsx(C,{value:"bgm",children:"Bangumi"}),t.jsx(C,{value:"vndb",children:"VNDB"}),t.jsx(C,{value:"mixed",children:"Mixed"}),t.jsx(C,{value:"custom",children:"Custom"}),t.jsx(C,{value:"Whitecloud",disabled:!0,children:"Whitecloud"})]})]}),l!=="vndb"&&l!=="custom"&&t.jsx(L,{label:s("pages.Detail.DataSourceUpdate.bgmId","Bangumi ID"),variant:"outlined",fullWidth:!0,value:i,onChange:u=>h(u.target.value),disabled:x||a}),l!=="bgm"&&l!=="custom"&&t.jsx(L,{label:s("pages.Detail.DataSourceUpdate.vndbId","VNDB ID"),variant:"outlined",fullWidth:!0,value:d,onChange:u=>g(u.target.value),disabled:x||a}),t.jsx(N,{variant:"contained",color:"primary",size:"large",fullWidth:!0,disabled:l==="custom"||x||a||!o||l==="bgm"&&!i||l==="vndb"&&!d||l==="mixed"&&!i&&!d,onClick:y,startIcon:x?t.jsx(T,{size:20,color:"inherit"}):t.jsx(G,{}),children:x?s("pages.Detail.DataSourceUpdate.loading","正在获取..."):s("pages.Detail.DataSourceUpdate.updateFromSource","从数据源更新数据")})]})},M=e=>{const o=e.lastIndexOf(".");return o!==-1?e.substring(o+1).toLowerCase():""},pe=async()=>{try{const e=await ee({title:"选择自定义封面",multiple:!1,directory:!1,filters:[{name:"图片文件",extensions:["png","jpg","jpeg","webp","gif","bmp"]}]});return!e||Array.isArray(e)?null:e}catch(e){throw console.error("选择图片文件失败:",e),e}},ge=async(e,o)=>{try{const n=o.split(/[/\\]/).pop()||"image",a=M(n),s=V(e);if(!s)throw new Error("资源目录路径未初始化");const i=Date.now(),h=`${a}_${i}`,d=`${s}\\cover_${e}_${h}`;try{await k("delete_game_covers",{gameId:e,coversDir:s})}catch{}return await k("copy_file",{src:o,dst:d}),h}catch(n){throw new Error(`上传图片失败: ${n}`)}},me=async e=>{try{const o=await ce(e),n=e.split(/[/\\]/).pop()||"",a=M(n)||"png",s=`image/${a==="jpg"?"jpeg":a}`,i=o.buffer.slice(o.byteOffset,o.byteOffset+o.byteLength),h=new Blob([i],{type:s});return URL.createObjectURL(h)}catch(o){throw console.error("生成预览 URL 失败:",o),o}},he=async(e,o)=>{try{const n=V(e);if(!n)throw new Error("资源目录路径未初始化");const a=`${n}\\cover_${e}_${o}`;await k("delete_file",{filePath:a})}catch(n){throw new Error(`删除自定义封面失败: ${n}`)}},fe=({selectedGame:e,onSave:o,disabled:n=!1})=>{const{t:a}=O(),[s,i]=m.useState(""),[h,d]=m.useState(""),[g,l]=m.useState(!1),[f,x]=m.useState(null),[c,D]=m.useState(null),[y,_]=m.useState(null);m.useEffect(()=>{if(e){i(e.localpath||"");const r=U(e,B.language);d(e.custom_name||r)}else i(""),d("")},[e]),m.useEffect(()=>()=>{c&&URL.revokeObjectURL(c)},[c]);const u=()=>{if(!e)return!1;const r=U(e,B.language),E=e.custom_name||r;return s!==(e.localpath||"")||h!==E||f!==null},p=async()=>{try{const r=await oe();r&&i(r)}catch(r){v.error(`${a("pages.Detail.GameInfoEdit.selectPathFailed","选择路径失败")}: ${r instanceof Error?r.message:a("pages.Detail.GameInfoEdit.unknownError","未知错误")}`)}},b=async()=>{if(!e||typeof e.id!="number"){v.error(a("pages.Detail.GameInfoEdit.invalidGameId","无效的游戏ID"));return}try{const r=await pe();if(r){if(c)try{URL.revokeObjectURL(c)}catch{}x(r);const E=await me(r);D(E)}}catch(r){v.error(`${a("pages.Detail.GameInfoEdit.selectImageFailed","选择图片失败")}: ${r instanceof Error?r.message:r}`)}},w=()=>y||(c||g&&c?c:e?W(e):""),z=async()=>{if(!e||typeof e.id!="number"||!e.custom_cover){v.error(a("pages.Detail.GameInfoEdit.invalidGameId","无效的游戏ID或无自定义封面"));return}l(!0);try{await he(e.id,e.custom_cover),await o({game:{custom_cover:null}})}catch(r){v.error(`${a("pages.Detail.GameInfoEdit.removeCustomCoverFailed","移除自定义封面失败")}: ${r instanceof Error?r.message:r}`)}finally{l(!1)}},A=async()=>{if(!(!e||!u())){l(!0);try{const r={};if(f&&e.id){const $=await ge(e.id,f);r.custom_cover=$}s!==(e.localpath||"")&&(r.localpath=s);const E=U(e,B.language),q=e.custom_name||E;if(h!==q&&(r.custom_name=h),await o({game:r}),f&&r.custom_cover){const $=W({...e,custom_cover:r.custom_cover});_($)}setTimeout(()=>{if(f&&(x(null),c)){try{URL.revokeObjectURL(c)}catch{}D(null)}_(null)},100)}catch(r){v.error(`${a("pages.Detail.GameInfoEdit.saveGameInfoFailed","保存游戏信息失败")}: ${r instanceof Error?r.message:a("pages.Detail.GameInfoEdit.unknownError","未知错误")}`)}finally{l(!1)}}};return t.jsxs(I,{sx:{display:"flex",flexDirection:"column",gap:3},children:[t.jsx(P,{children:t.jsxs(R,{children:[t.jsx(j,{variant:"h6",gutterBottom:!0,children:a("pages.Detail.GameInfoEdit.customizeGame","自定义游戏信息")}),t.jsxs(S,{direction:{xs:"column",md:"row"},spacing:3,children:[t.jsxs(I,{sx:{flex:"0 0 300px"},children:[t.jsx(j,{variant:"subtitle1",gutterBottom:!0,children:a("pages.Detail.GameInfoEdit.customCover","自定义封面")}),t.jsxs(S,{spacing:2,children:[t.jsx(I,{children:t.jsx("img",{src:w(),alt:"Game Cover",style:{maxWidth:"200px",maxHeight:"300px",objectFit:"contain",borderRadius:"8px"}})}),t.jsxs(S,{direction:"row",spacing:1,flexWrap:"wrap",children:[t.jsx(N,{variant:"outlined",onClick:b,startIcon:t.jsx(ue,{}),disabled:g||n||!e,size:"small",children:a("pages.Detail.GameInfoEdit.selectImage","选择图片")}),e?.custom_cover&&t.jsx(te,{onClick:z,disabled:g||n,color:"error",size:"small",title:a("pages.Detail.GameInfoEdit.removeCustomCover","移除自定义封面"),children:t.jsx(ae,{})})]}),e?.custom_cover&&t.jsxs(j,{variant:"caption",color:"textSecondary",children:[a("pages.Detail.GameInfoEdit.hasCustomCover","已设置自定义封面"),": ",e.custom_cover]}),f&&t.jsxs(j,{variant:"caption",color:"primary",children:[a("pages.Detail.GameInfoEdit.previewSelected","已选择新图片，保存后生效"),": ",f.split(/[/\\]/).pop()]})]})]}),t.jsxs(I,{sx:{flex:1},children:[t.jsx(j,{variant:"subtitle1",gutterBottom:!0,children:a("pages.Detail.GameInfoEdit.gameNote","游戏备注")}),t.jsx(S,{spacing:2,children:t.jsx(L,{label:a("pages.Detail.GameInfoEdit.customGameName","自定义游戏名称"),variant:"outlined",fullWidth:!0,value:h,onChange:r=>d(r.target.value),disabled:g||n||!e,placeholder:e?U(e,B.language):a("pages.Detail.GameInfoEdit.enterGameNote","请输入游戏备注"),helperText:a("pages.Detail.GameInfoEdit.noteHelperText","您可以为游戏设置一个自定义的显示名称，留空则使用默认名称")})})]})]})]})}),t.jsxs(I,{sx:{display:"flex",gap:1},children:[t.jsx(L,{label:a("pages.Detail.GameInfoEdit.localPath","可执行文件路径"),variant:"outlined",fullWidth:!0,value:s,onChange:r=>i(r.target.value),disabled:g||n||!e}),t.jsx(N,{variant:"outlined",onClick:p,disabled:g||n||!e,sx:{minWidth:"40px",px:1},children:t.jsx(re,{})})]}),t.jsx(N,{variant:"contained",color:"primary",size:"large",fullWidth:!0,onClick:A,disabled:g||n||!e||!u(),startIcon:g?t.jsx(T,{size:20,color:"inherit"}):t.jsx(le,{}),sx:{mt:2},children:g?a("pages.Detail.GameInfoEdit.saving","保存中..."):a("pages.Detail.GameInfoEdit.saveAllChanges","保存所有更改")})]})},ye=()=>{const{bgmToken:e,updateGame:o,selectedGame:n}=se(),a=Number(ne().pathname.split("/").pop()),{t:s}=O(),[i,h]=m.useState(null),[d,g]=m.useState(!1),l=()=>{if(i){switch(o(a,i),i.game.id_type){case"bgm":F.deleteVndbData(a),F.deleteOtherData(a);break;case"vndb":F.deleteBgmData(a),F.deleteOtherData(a);break}g(!1),v.success(s("pages.Detail.Edit.updateSuccess","游戏信息已更新"))}},f=c=>{h(c),g(!0)},x=async c=>{if(n)try{await o(a,c),v.success(s("pages.Detail.Edit.updateSuccess","游戏信息已成功更新"))}catch(D){const y=D instanceof Error?D.message:s("pages.Detail.Edit.unknownError","未知错误");throw v.error(y),D}};return t.jsxs(I,{sx:{p:3},children:[t.jsx(ie,{open:d,setOpen:g,onConfirm:l,fullgame:i}),t.jsxs(S,{spacing:4,children:[t.jsx(P,{children:t.jsxs(R,{children:[t.jsx(j,{variant:"h6",gutterBottom:!0,children:s("pages.Detail.Edit.dataSourceUpdate","数据源更新")}),t.jsx(de,{bgmToken:e,selectedGame:n,onDataFetched:f})]})}),t.jsx(P,{children:t.jsxs(R,{children:[t.jsx(j,{variant:"h6",gutterBottom:!0,children:s("pages.Detail.Edit.gameInfoEdit","游戏资料编辑")}),t.jsx(fe,{selectedGame:n,onSave:x})]})})]})]})};export{ye as Edit};
