import{e as Ca,j as t,i as G,r as l,bd as W,be as Ea,B as j,bf as _a,av as Na,az as ka,$ as U,ay as C,aw as L,W as da,aH as Ba,ad as E,bg as Pa,au as Ua,bh as ca,bi as Ta,aL as Fa,at as na,n as Y,U as H,ao as Z,T as S,X as T,a3 as Wa,Y as ia,aA as Aa,aB as La,ai as za,b8 as Oa,l as Q,bj as $a,bk as A,bl as oa,bm as Ma,f as Ha,Q as Va,bn as Ya}from"./index-D1SIH30A.js";import{C as z}from"./Card-CXRbG3bK.js";import{C as O}from"./CardContent-CHLnZwAB.js";const Ra=Ca([t.jsx("circle",{cx:"12",cy:"12",r:"3.2"},"0"),t.jsx("path",{d:"M9 2 7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5"},"1")]),Ja=({bgmToken:a,selectedGame:d,onDataFetched:c,disabled:s=!1})=>{const{t:n}=G(),[u,x]=l.useState(d?.bgm_id||""),[f,h]=l.useState(d?.vndb_id||""),[v,y]=l.useState(d?.ymgal_id||""),[r,i]=l.useState(d?.id_type||""),[p,b]=l.useState(!1);l.useEffect(()=>{x(d?.bgm_id||""),h(d?.vndb_id||""),y(d?.ymgal_id||""),i(d?.id_type||"")},[d]);const _=l.useCallback(async()=>{if(!d)throw new Error(n("pages.Detail.DataSourceUpdate.noGameSelected","未选择游戏"));if(r==="custom")throw new Error(n("pages.Detail.DataSourceUpdate.customModeWarning","自定义模式无法从数据源更新。"));let o=null;if(r==="bgm"&&u)o=await W.getGameById(u,r,a);else if(r==="vndb"&&f)o=await W.getGameById(f,r);else if(r==="ymgal"&&v)o=await W.getGameById(v,r);else if(r==="mixed"){if(!u&&!f&&!v)throw new Error(n("pages.Detail.DataSourceUpdate.bgmOrVndbIdRequired","Bangumi ID、VNDB ID 或 YMGal ID 不能为空"));o=await W.getGameByIds({bgmId:u,vndbId:f,ymgalId:v,bgmToken:a})}else throw new Error(n("pages.Detail.DataSourceUpdate.invalidIdType","无效的ID类型"));if(!o)throw new Error(n("pages.Detail.DataSourceUpdate.noDataFetched","未获取到数据或数据源无效。"));if(o.ymgal_id&&!Ea(o.ymgal_data)){const I=await W.getGameByIds({ymgalId:o.ymgal_id});I?.ymgal_data&&(o.ymgal_data=I.ymgal_data,o.date=I.date||o.date)}return o},[r,u,f,v,a,d,n]),N=async()=>{b(!0);try{const o=await _();c(o)}catch(o){const I=o instanceof Error?o.message:n("pages.Detail.DataSourceUpdate.unknownError","未知错误");E.error(I)}finally{b(!1)}},k=o=>{i(o.target.value)};return t.jsxs(j,{sx:{display:"flex",flexDirection:"column",gap:3},children:[t.jsxs(_a,{fullWidth:!0,disabled:p||s||!d,children:[t.jsx(Na,{id:"id-type-label",children:n("pages.Detail.DataSourceUpdate.dataSource","数据源")}),t.jsxs(ka,{labelId:"id-type-label",value:r,onChange:k,label:n("pages.Detail.DataSourceUpdate.dataSource","数据源"),children:[t.jsx(U,{value:"bgm",children:"Bangumi"}),t.jsx(U,{value:"vndb",children:"VNDB"}),t.jsx(U,{value:"ymgal",children:"YMGal"}),t.jsx(U,{value:"mixed",children:"Mixed"}),t.jsx(U,{value:"custom",children:"Custom"}),t.jsx(U,{value:"Whitecloud",disabled:!0,children:"Whitecloud"})]})]}),(r==="bgm"||r==="mixed")&&t.jsx(C,{label:n("pages.Detail.DataSourceUpdate.bgmId","Bangumi ID"),variant:"outlined",fullWidth:!0,value:u,onChange:o=>x(o.target.value),disabled:p||s,required:r==="bgm"}),(r==="vndb"||r==="mixed")&&t.jsx(C,{label:n("pages.Detail.DataSourceUpdate.vndbId","VNDB ID"),variant:"outlined",fullWidth:!0,value:f,onChange:o=>h(o.target.value),disabled:p||s,required:r==="vndb"}),(r==="ymgal"||r==="mixed")&&t.jsx(C,{label:n("pages.Detail.DataSourceUpdate.ymgalId","YMGal ID"),variant:"outlined",fullWidth:!0,value:v,onChange:o=>y(o.target.value),disabled:p||s,required:r==="ymgal"}),t.jsx(L,{variant:"contained",color:"primary",size:"large",fullWidth:!0,disabled:r==="custom"||p||s||!d||r==="bgm"&&!u||r==="vndb"&&!f||r==="ymgal"&&!v||r==="mixed"&&!u&&!f&&!v,onClick:N,startIcon:p?t.jsx(da,{size:20,color:"inherit"}):t.jsx(Ba,{}),children:p?n("pages.Detail.DataSourceUpdate.loading","正在获取..."):n("pages.Detail.DataSourceUpdate.updateFromSource","从数据源更新数据")})]})},qa=a=>{const d=a.lastIndexOf(".");return d!==-1?a.substring(d+1).toLowerCase():""},Ka=async()=>{try{const a=await Ua({title:"选择自定义封面",multiple:!1,directory:!1,filters:[{name:"图片文件",extensions:["png","jpg","jpeg","webp","gif","bmp"]}]});return!a||Array.isArray(a)?null:a}catch(a){throw console.error("选择图片文件失败:",a),a}},Xa=async(a,d)=>{try{const c=ca(d),s=qa(c),n=Ta(a);if(!n)throw new Error("资源目录路径未初始化");const u=Date.now(),x=`${s}_${u}`,f=Fa(n,`cover_${a}_${x}`);try{await na("delete_game_covers",{gameId:a,coversDir:n})}catch{}return await na("copy_file",{src:d,dst:f}),x}catch(c){throw new Error(`上传图片失败: ${c}`)}},Qa=a=>Pa(a),Za=()=>{const[a,d]=l.useState(null),[c,s]=l.useState(null),n=l.useCallback(()=>{s(null),d(null)},[]),u=l.useCallback(x=>{d(x),s(Qa(x))},[]);return{selectedPath:a,previewUrl:c,selectImage:u,cleanup:n}},V={display:"flex",flexWrap:"wrap",alignItems:"center",gap:.5,p:1,border:"1px solid",borderColor:"divider",borderRadius:1,minHeight:"42px","&:focus-within":{borderWidth:"2px"}},la={border:"none",outline:"none",background:"transparent",flex:1,minWidth:"120px",fontSize:"14px",padding:"4px",color:"inherit"},Ga=(a,d,c,s,n,u,x,f,h,v,y)=>{const r={},i=A(d,a.localpath);i!==void 0&&(r.localpath=i);const p=a.custom_data||{},b=Y(a,s),_=p.name||b,N=a.summary??"",k=a.developer??"",o=Z(a)??!1,I=a.date??"",g={...p};let D=!1;const B=A(c,_);if(B!==void 0&&(g.name=B,D=!0),n!==void 0&&(g.image=n,D=!0),u!==void 0){const m=oa(u,p.aliases);m!==void 0&&(g.aliases=m,D=!0)}if(x!==void 0){const m=A(x,N);m!==void 0&&(g.summary=m,D=!0)}if(f!==void 0){const m=oa(f,p.tags);m!==void 0&&(g.tags=m,D=!0)}if(h!==void 0){const m=A(h,k);m!==void 0&&(g.developer=m,D=!0)}if(v!==void 0){const m=Ma(v,o);m!==void 0&&(g.nsfw=m,D=!0)}if(y!==void 0){const m=A(y,I);m!==void 0&&(g.date=m,D=!0)}return D&&(r.custom_data=g),r},ae=({selectedGame:a,onSave:d,disabled:c=!1})=>{const{t:s}=G(),[n,u]=l.useState(""),[x,f]=l.useState(""),[h,v]=l.useState([]),[y,r]=l.useState(""),[i,p]=l.useState([]),[b,_]=l.useState(""),[N,k]=l.useState(!1),[o,I]=l.useState(""),[g,D]=l.useState(!1),[B,m]=l.useState(""),[R,aa]=l.useState(""),{selectedPath:P,previewUrl:ea,selectImage:ua,cleanup:$}=Za(),[F,M]=l.useState(!1),[ta,J]=l.useState(null),[q,K]=l.useState(null),sa=l.useCallback(e=>{u(e.localpath??""),f(Y(e,H.language)),v(e.custom_data?.aliases??[]),r(e.summary??""),p(e.custom_data?.tags??[]),_(e.developer??""),k(Z(e)??!1),I(e.date??""),M(!1),$()},[$]);l.useEffect(()=>{a?sa(a):(u(""),f(""),v([]),r(""),p([]),_(""),k(!1),I(""),M(!1))},[a?.id,a?.bgm_id,a?.vndb_id,a?.ymgal_id,a?.id_type,a?.localpath,JSON.stringify(a?.custom_data),sa]),l.useEffect(()=>{q&&a?.custom_data?.image===q&&(K(null),J(null))},[q,a?.custom_data?.image]);const ra=()=>{if(!a)return!1;const e=Y(a,H.language),w=a.custom_data?.name||e,X=a.summary??"",ja=a.developer??"",Sa=Z(a)??!1,wa=a.date??"";return n!==(a.localpath??"")||x!==w||P!==null||F||JSON.stringify(h)!==JSON.stringify(a.custom_data?.aliases??[])||y!==X||JSON.stringify(i)!==JSON.stringify(a.custom_data?.tags??[])||b!==ja||N!==Sa||o!==wa},ga=async()=>{try{const e=await $a();e&&u(e)}catch(e){E.error(`${s("pages.Detail.GameInfoEdit.selectPathFailed","选择路径失败")}: ${e instanceof Error?e.message:s("pages.Detail.GameInfoEdit.unknownError","未知错误")}`)}},pa=async()=>{if(!a||typeof a.id!="number"){E.error(s("pages.Detail.GameInfoEdit.invalidGameId","无效的游戏ID"));return}try{const e=await Ka();if(!e)return;M(!1),ua(e)}catch(e){E.error(`${s("pages.Detail.GameInfoEdit.selectImageFailed","选择图片失败")}: ${e instanceof Error?e.message:e}`)}},ma=()=>F&&a?Q({...a,custom_data:{...a.custom_data,image:void 0}}):ta||ea||(a?Q(a):""),fa=()=>{M(!0),$()},ha=()=>{const e=B.trim();e&&!h.includes(e)&&(v([...h,e]),m(""))},va=e=>{v(h.filter(w=>w!==e))},xa=e=>{e.key==="Enter"?(e.preventDefault(),ha()):e.key==="Backspace"&&B===""&&h.length>0&&(e.preventDefault(),v(h.slice(0,-1)))},Da=()=>{const e=R.trim();e&&!i.includes(e)&&(p([...i,e]),aa(""))},ya=e=>{p(i.filter(w=>w!==e))},Ia=e=>{e.key==="Enter"?(e.preventDefault(),Da()):e.key==="Backspace"&&R===""&&i.length>0&&(e.preventDefault(),p(i.slice(0,-1)))},ba=async()=>{if(!(!a||!ra())){D(!0);try{let e;F?e=null:P&&a.id&&(e=await Xa(a.id,P));const w=Ga(a,n,x,H.language,e,h,y,i,b,N,o);if(Object.keys(w).length===0)return;if(await d(w),e&&typeof e=="string"){K(e);const X=Q({...a,custom_data:{...a.custom_data,image:e}});J(X)}else e===null&&(K(null),J(null));setTimeout(()=>{$()},100)}catch(e){E.error(`${s("pages.Detail.GameInfoEdit.saveGameInfoFailed","保存游戏信息失败")}: ${e instanceof Error?e.message:s("pages.Detail.GameInfoEdit.unknownError","未知错误")}`)}finally{D(!1)}}};return t.jsxs(j,{className:"flex flex-col gap-3",children:[t.jsx(z,{children:t.jsxs(O,{children:[t.jsx(S,{variant:"h6",gutterBottom:!0,children:s("pages.Detail.GameInfoEdit.coverAndBasicInfo","封面与基本信息")}),t.jsxs(T,{direction:{xs:"column",md:"row"},spacing:3,children:[t.jsxs(j,{className:"flex-shrink-0",children:[t.jsx("img",{src:ma(),alt:"Game Cover",className:"w-70 h-100 object-cover rounded-2 border border-gray-300"}),t.jsxs(T,{spacing:1,className:"mt-2",children:[t.jsxs(T,{direction:"row",spacing:1,flexWrap:"wrap",children:[t.jsx(L,{variant:"outlined",onClick:pa,startIcon:t.jsx(Ra,{}),disabled:g||c||!a,size:"small",children:s("pages.Detail.GameInfoEdit.selectImage","选择图片")}),a?.custom_data?.image&&!F&&t.jsx(L,{variant:"outlined",onClick:fa,startIcon:t.jsx(Wa,{}),disabled:g||c,color:"error",size:"small",children:s("pages.Detail.GameInfoEdit.removeCustomCover","移除封面")})]}),a?.custom_data?.image&&!F&&!P&&t.jsxs(S,{variant:"caption",color:"textSecondary",children:[s("pages.Detail.GameInfoEdit.hasCustomCover","已设置自定义封面"),": ",a.custom_data.image]}),P&&t.jsxs(S,{variant:"caption",color:"primary",children:[s("pages.Detail.GameInfoEdit.previewSelected","已选择新图片，保存后生效"),": ",ca(P)]})]})]}),t.jsxs(T,{spacing:3,sx:{flex:1},children:[t.jsx(C,{label:s("pages.Detail.GameInfoEdit.customGameName","自定义游戏名称"),variant:"outlined",fullWidth:!0,value:x,onChange:e=>f(e.target.value),disabled:g||c||!a,placeholder:a?Y(a,H.language):s("pages.Detail.GameInfoEdit.enterGameNote","请输入游戏备注"),helperText:s("pages.Detail.GameInfoEdit.noteHelperText","您可以为游戏设置一个自定义的显示名称，留空则使用默认名称")}),t.jsxs(j,{children:[t.jsx(S,{variant:"subtitle2",gutterBottom:!0,children:s("pages.Detail.GameInfoEdit.aliases","别名")}),t.jsxs(j,{sx:{...V,"&:focus-within":{...V["&:focus-within"],borderColor:"primary.main"}},children:[h.map(e=>t.jsx(ia,{label:e,onDelete:()=>va(e),disabled:g||c,color:"primary",variant:"outlined",size:"small"},e)),t.jsx("input",{type:"text",value:B,onChange:e=>m(e.target.value),onKeyDown:xa,placeholder:h.length===0?s("pages.Detail.GameInfoEdit.addAliasPlaceholder","输入别名后按回车添加，退格键删除"):"",disabled:g||c||!a,style:la})]})]}),t.jsx(C,{label:s("pages.Detail.GameInfoEdit.developer","开发商"),variant:"outlined",fullWidth:!0,value:b,onChange:e=>_(e.target.value),disabled:g||c||!a,placeholder:s("pages.Detail.GameInfoEdit.developerPlaceholder","多个开发商请使用 / 分隔"),helperText:s("pages.Detail.GameInfoEdit.developerHelperText","例如：开发商A / 开发商B")}),t.jsx(C,{label:s("pages.Detail.GameInfoEdit.releaseDate","发行日期"),variant:"outlined",fullWidth:!0,type:"date",value:o,onChange:e=>I(e.target.value),disabled:g||c||!a,InputLabelProps:{shrink:!0},helperText:s("pages.Detail.GameInfoEdit.releaseDateHelperText","游戏的发行日期")}),t.jsx(j,{children:t.jsx(Aa,{control:t.jsx(La,{checked:N,onChange:e=>k(e.target.checked),disabled:g||c||!a,color:"warning"}),label:s("pages.Detail.GameInfoEdit.nsfw","NSFW (18+)")})})]})]})]})}),t.jsx(z,{children:t.jsxs(O,{children:[t.jsx(S,{variant:"h6",gutterBottom:!0,children:s("pages.Detail.GameInfoEdit.descriptionAndTags","简介与标签")}),t.jsxs(T,{spacing:3,children:[t.jsx(C,{label:s("pages.Detail.GameInfoEdit.summary","游戏简介"),variant:"outlined",fullWidth:!0,multiline:!0,minRows:4,value:y,onChange:e=>r(e.target.value),disabled:g||c||!a,placeholder:s("pages.Detail.GameInfoEdit.summaryPlaceholder","请输入游戏简介"),helperText:s("pages.Detail.GameInfoEdit.summaryHelperText","游戏的详细介绍（可拖动右下角调整大小）"),InputProps:{sx:{"& textarea":{resize:"vertical",overflow:"auto !important"}}}}),t.jsxs(j,{children:[t.jsx(S,{variant:"subtitle2",gutterBottom:!0,children:s("pages.Detail.GameInfoEdit.tags","标签")}),t.jsxs(j,{sx:{...V,"&:focus-within":{...V["&:focus-within"],borderColor:"primary.main"}},children:[i.map(e=>t.jsx(ia,{label:e,onDelete:()=>ya(e),disabled:g||c,color:"primary",variant:"outlined",size:"small"},e)),t.jsx("input",{type:"text",value:R,onChange:e=>aa(e.target.value),onKeyDown:Ia,placeholder:i.length===0?s("pages.Detail.GameInfoEdit.addTagPlaceholder","输入标签后按回车添加，退格键删除"):"",disabled:g||c||!a,style:la})]})]})]})]})}),t.jsx(z,{children:t.jsxs(O,{children:[t.jsx(S,{variant:"h6",gutterBottom:!0,children:s("pages.Detail.GameInfoEdit.gamePath","游戏路径")}),t.jsxs(j,{className:"flex gap-1",children:[t.jsx(C,{label:s("pages.Detail.GameInfoEdit.localPath","可执行文件路径"),variant:"outlined",fullWidth:!0,value:n,onChange:e=>u(e.target.value),disabled:g||c||!a}),t.jsx(L,{variant:"outlined",onClick:ga,disabled:g||c||!a,className:"min-w-10 px-1",children:t.jsx(za,{})})]})]})}),t.jsx(L,{variant:"contained",color:"primary",size:"large",fullWidth:!0,onClick:ba,disabled:g||c||!a||!ra(),startIcon:g?t.jsx(da,{size:20,color:"inherit"}):t.jsx(Oa,{}),className:"mt-2",children:g?s("pages.Detail.GameInfoEdit.saving","保存中..."):s("pages.Detail.GameInfoEdit.saveAllChanges","保存所有更改")})]})},re=()=>{const{bgmToken:a,updateGame:d,selectedGame:c}=Ha(),s=Number(Va().pathname.split("/").pop()),{t:n}=G(),[u,x]=l.useState(null),[f,h]=l.useState(!1),v=()=>{if(u){const i={...u};switch(u.id_type){case"bgm":i.vndb_data=null,i.ymgal_data=null;break;case"vndb":i.bgm_data=null,i.ymgal_data=null;break;case"ymgal":i.bgm_data=null,i.vndb_data=null;break;case"mixed":u.bgm_id||(i.bgm_data=null,i.bgm_id=null),u.vndb_id||(i.vndb_data=null,i.vndb_id=null),u.ymgal_id||(i.ymgal_data=null,i.ymgal_id=null);break}d(s,i),h(!1),E.success(n("pages.Detail.Edit.updateSuccess","游戏信息已更新"))}},y=i=>{x(i),h(!0)},r=async i=>{if(c)try{await d(s,i),E.success(n("pages.Detail.Edit.updateSuccess","游戏信息已成功更新"))}catch(p){const b=p instanceof Error?p.message:n("pages.Detail.Edit.unknownError","未知错误");throw E.error(b),p}};return t.jsxs(j,{sx:{p:3},children:[t.jsx(Ya,{open:f,setOpen:h,onConfirm:v,fullgame:u}),t.jsxs(T,{spacing:4,children:[t.jsx(z,{children:t.jsxs(O,{children:[t.jsx(S,{variant:"h6",gutterBottom:!0,children:n("pages.Detail.Edit.dataSourceUpdate","数据源更新")}),t.jsx(Ja,{bgmToken:a,selectedGame:c,onDataFetched:y})]})}),t.jsx(z,{children:t.jsxs(O,{children:[t.jsx(S,{variant:"h6",gutterBottom:!0,children:n("pages.Detail.Edit.gameInfoEdit","游戏资料编辑")}),t.jsx(ae,{selectedGame:c,onSave:r})]})})]})]})};export{re as Edit};
