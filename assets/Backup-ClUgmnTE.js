import{f as N,i as Q,r as i,aF as m,aw as n,j as e,B as $,a8 as x,T as d,as as V,an as X,ao as Y,D as Z,ah as ee,al as g,J as f,a7 as E,q as ae,t as te,w as se,aG as re,aj as ie,I as ne,C as ce,az as oe,aH as le,aI as pe,aJ as de,aK as ue,ay as ge,aL as he}from"./index-8LpMZBdz.js";import{B as ke}from"./Backup-saa6L5ZB.js";import{S as xe}from"./Save-4_kBfRSx.js";import{C as v}from"./Card-CcP84HZ5.js";import{C as S}from"./CardContent-BVd1vCqa.js";const Se=()=>{const{selectedGame:s,updateGame:I}=N(),{t}=Q(),[o,D]=i.useState(""),[j,L]=i.useState([]),[l,y]=i.useState(!1),[P,B]=i.useState(!1),[p,F]=i.useState(null),[T,b]=i.useState(!1),[z,G]=i.useState(!1),[u,w]=i.useState(!1),h=i.useCallback(async()=>{if(s?.id)try{const a=await m.getSavedataRecords(s.id);L(a)}catch(a){console.error("加载备份列表失败:",a),n.error(t("pages.Detail.Backup.loadBackupsFailed","加载备份列表失败"))}},[s?.id,t]);i.useEffect(()=>{h()},[h]),i.useEffect(()=>{s&&G(s.autosave===1)},[s?.autosave]),i.useEffect(()=>{s&&D(s.savepath||"")},[s?.savepath]);const C=async(a,r,k)=>{if(s?.id){w(!0);try{const c={game:{...a}};await I(s.id,c),n.success(r)}catch(c){const K=c instanceof Error?c.message:t("pages.Detail.Backup.unknownError","未知错误");throw n.error(`${k}: ${K}`),c}finally{w(!1)}}},M=async()=>{const a=await oe();a&&D(a)},R=async()=>{await C({savepath:o},t("pages.Detail.Backup.pathUpdateSuccess","存档路径更新成功"),t("pages.Detail.Backup.pathUpdateFailed","路径更新失败"))},A=async a=>{const r=a?t("pages.Detail.Backup.autoSaveEnabled","自动备份已启用"):t("pages.Detail.Backup.autoSaveDisabled","自动备份已禁用");await C({autosave:a?1:0},r,t("pages.Detail.Backup.autoSaveUpdateFailed","自动备份设置失败"))},U=async()=>{if(!o||!s?.id){n.error(t("pages.Detail.Backup.pathRequired","请先选择存档文件夹"));return}y(!0);try{await le(s.id,o),n.success(t("pages.Detail.Backup.backupSuccess","备份创建成功")),h()}catch(a){const r=a instanceof Error?a.message:t("pages.Detail.Backup.unknownError","未知错误");n.error(`${t("pages.Detail.Backup.backupFailed","备份失败")}: ${r}`)}finally{y(!1)}},O=async()=>{if(s?.id)try{await pe(s.id)}catch(a){const r=a instanceof Error?a.message:t("pages.Detail.Backup.unknownError","未知错误");n.error(`${t("pages.Detail.Backup.openFolderFailed","打开文件夹失败")}: ${r}`)}},W=async()=>{if(!o){n.error(t("pages.Detail.Backup.pathRequired","请先选择存档文件夹"));return}try{await de(o)}catch(a){const r=a instanceof Error?a.message:t("pages.Detail.Backup.unknownError","未知错误");n.error(`${t("pages.Detail.Backup.openFolderFailed","打开文件夹失败")}: ${r}`)}},_=a=>{F(a),B(!0)},q=async()=>{if(p){b(!0);try{const a=await ue(),r=await ge.getSaveRootPath(),c=`${r===""?`${a}`:`${r}`}/backups/game_${p.game_id}/${p.file}`;await he(c),await m.deleteSavedataRecord(p.id),n.success(t("pages.Detail.Backup.deleteSuccess","备份删除成功")),h(),B(!1),F(null)}catch(a){await m.deleteSavedataRecord(p.id);const r=a instanceof Error?a.message:t("pages.Detail.Backup.unknownError","未知错误");n.error(`${t("pages.Detail.Backup.deleteFailed","删除失败")}: ${r}`)}finally{b(!1)}}},H=a=>{if(a===0)return"0 B";const r=1024,k=["B","KB","MB","GB"],c=Math.floor(Math.log(a)/Math.log(r));return`${Number.parseFloat((a/r**c).toFixed(2))} ${k[c]}`},J=a=>new Date(a*1e3).toLocaleString();return e.jsxs($,{sx:{p:3},children:[e.jsxs(x,{spacing:3,children:[e.jsx(v,{children:e.jsxs(S,{children:[e.jsx(d,{variant:"h6",gutterBottom:!0,children:t("pages.Detail.Backup.settings","备份设置")}),e.jsxs(x,{spacing:2,children:[e.jsx(V,{title:s?.savepath?"":t("pages.Detail.Backup.setPathForAutosave","请先设置存档路径以启用自动备份"),children:e.jsx("div",{children:e.jsx(X,{control:e.jsx(Y,{checked:z,onChange:a=>A(a.target.checked),disabled:u||!s?.savepath}),label:t("pages.Detail.Backup.autoSave","自动备份")})})}),e.jsx(Z,{}),e.jsx(d,{variant:"subtitle2",color:"textSecondary",children:t("pages.Detail.Backup.savePathSettings","存档路径设置")}),e.jsxs($,{sx:{display:"flex",gap:1},children:[e.jsx(ee,{label:t("pages.Detail.Backup.saveDataPath","存档文件夹路径"),variant:"outlined",fullWidth:!0,value:o,onChange:a=>D(a.target.value),disabled:l||u||!s,placeholder:t("pages.Detail.Backup.selectSaveDataFolder","选择存档文件夹")}),e.jsx(g,{variant:"outlined",onClick:M,disabled:l||u||!s,sx:{minWidth:"40px",px:1},children:e.jsx(f,{})}),e.jsx(g,{variant:"outlined",onClick:R,disabled:l||u||!s||!o,startIcon:u?e.jsx(E,{size:16}):e.jsx(xe,{}),sx:{minWidth:"100px"},children:u?t("pages.Detail.Backup.updating","更新中..."):t("pages.Detail.Backup.updatePath","更新路径")})]})]})]})}),e.jsx(v,{children:e.jsxs(S,{children:[e.jsx(d,{variant:"h6",gutterBottom:!0,children:t("pages.Detail.Backup.manualBackup","手动备份")}),e.jsxs(x,{spacing:2,children:[e.jsx(g,{variant:"contained",color:"primary",size:"large",fullWidth:!0,onClick:U,disabled:l||!o||!s?.savepath,startIcon:l?e.jsx(E,{size:20,color:"inherit"}):e.jsx(ke,{}),children:l?t("pages.Detail.Backup.creating","正在创建备份..."):t("pages.Detail.Backup.createBackup","创建备份")}),e.jsxs(x,{direction:"row",spacing:1,children:[e.jsx(g,{variant:"outlined",size:"medium",onClick:()=>O(),disabled:!s,startIcon:e.jsx(f,{}),sx:{flex:1},children:t("pages.Detail.Backup.openBackupFolder","打开备份文件夹")}),e.jsx(g,{variant:"outlined",size:"medium",onClick:()=>W(),disabled:!o||!s?.savepath,startIcon:e.jsx(f,{}),sx:{flex:1},children:t("pages.Detail.Backup.openSaveDataFolder","打开存档文件夹")})]})]})]})}),e.jsx(v,{children:e.jsxs(S,{children:[e.jsx(d,{variant:"h6",gutterBottom:!0,children:t("pages.Detail.Backup.backupHistory","备份历史")}),j.length===0?e.jsx(d,{color:"textSecondary",component:"div",children:t("pages.Detail.Backup.noBackups","暂无备份记录")}):e.jsx(ae,{children:j.map(a=>e.jsxs(te,{divider:!0,children:[e.jsx(se,{primary:a.file,secondary:e.jsxs(e.Fragment,{children:[e.jsxs(d,{variant:"body2",color:"textSecondary",component:"span",children:[t("pages.Detail.Backup.backupTime","备份时间"),":"," ",J(a.backup_time)]}),e.jsx("br",{}),e.jsxs(d,{variant:"body2",color:"textSecondary",component:"span",children:[t("pages.Detail.Backup.fileSize","文件大小"),":"," ",H(a.file_size)]})]})}),e.jsx(re,{children:e.jsx(ie,{edge:"end",onClick:()=>_(a),disabled:l,color:"error",children:e.jsx(ne,{})})})]},a.id))})]})})]}),e.jsx(ce,{open:P,setOpen:B,onConfirm:q,isLoading:T,title:t("components.AlertBox.deleteBackupTitle","删除备份"),message:p?`${t("pages.Detail.Backup.confirmDelete","确定要删除备份")} "${p.file}" ${t("pages.Detail.Backup.confirmDeleteSuffix","吗？此操作不可撤销。")}`:void 0})]})};export{Se as Backup};
