import{Q as $,aO as B,r as o,aP as H}from"./index-D1SIH30A.js";const C={containerSelector:"main",timeout:1500,debug:!1,stabilityDelay:0,useKeepAlive:!1};function z(d,O={}){const{containerSelector:g,isLoading:w,timeout:y,debug:S,stabilityDelay:k,useKeepAlive:f}={...C,...O},u=$(),{scrollPositions:x}=B(),c=o.useRef(null),r=o.useRef(!1),A=o.useRef(""),l=o.useRef(0),s=o.useRef(null),e=o.useCallback((...t)=>{S&&console.log("[useScrollRestore]",...t)},[S]);o.useEffect(()=>{"scrollRestoration"in window.history&&(window.history.scrollRestoration="manual")},[]);const R=o.useCallback(()=>{if(A.current!==u.pathname&&(r.current=!1,A.current=u.pathname,l.current=0),c.current&&(e("Cleaning up previous effect"),c.current(),c.current=null),w){e("Skipping: isLoading=true");return}const t=document.querySelector(g);if(!t){e("Container not found:",g);return}const i=u.pathname===d&&x[d]||0;if(e("Target position:",i,"for path:",u.pathname),i===0){t.scrollTop=0,r.current=!0,e("Scrolled to top immediately");return}if(r.current){e("Already settled, skipping");return}let a=null,m=null;const v=()=>{a&&(a.disconnect(),a=null),m!==null&&(window.clearTimeout(m),m=null),s.current!==null&&(window.clearTimeout(s.current),s.current=null)},b=n=>{if(r.current)return;const p=Math.max(0,t.scrollHeight-t.clientHeight),h=Math.max(0,Math.min(i,p)),E=t.style.scrollBehavior;t.style.scrollBehavior="auto",t.scrollTop=h,t.style.scrollBehavior=E,r.current=!0,h<i?e(`⚠ Restored to bottom (${h}/${i}) - ${n}`):e(`✓ Restored scroll to ${h} - ${n}`),v()},T=()=>{const n=t.scrollHeight,p=n-t.clientHeight;if(e("Height check:",{current:n,last:l.current,maxScroll:p,target:i}),p>=i){b("content sufficient");return}if(l.current>0&&n===l.current){b("content stable");return}l.current=n,s.current!==null&&window.clearTimeout(s.current),s.current=window.setTimeout(()=>{r.current||T()},k)};T();try{a=new ResizeObserver(()=>{r.current||T()}),a.observe(t),e("ResizeObserver attached")}catch(n){e("ResizeObserver not available",n)}return m=window.setTimeout(()=>{r.current||(e("⏰ Timeout reached, forcing restore"),b("timeout"))},y),c.current=v,v},[u.pathname,d,x,w,g,y,k,e]);o.useEffect(()=>{f||R()},[f,R]),H.useActivate(()=>{f&&(e("[KeepAlive] 组件激活，触发滚动恢复"),r.current=!1,l.current=0,R())}),H.useUnactivate(()=>{f&&c.current&&(c.current(),c.current=null)})}export{z as u};
